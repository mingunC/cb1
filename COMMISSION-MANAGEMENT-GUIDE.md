# 수수료 관리 시스템 가이드

## 📋 개요

관리자 대시보드에 프로젝트 수수료를 추적하고 관리하는 새로운 기능이 추가되었습니다. 고객이 프로젝트를 시작하면 자동으로 수수료가 추적되며, 관리자가 수동으로 확인하고 관리할 수 있습니다.

## 🚀 설치 방법

### 1. 데이터베이스 테이블 생성

Supabase SQL Editor에서 다음 파일을 실행하세요:

```sql
-- create-commission-management-table.sql 파일의 내용을 실행
```

이 스크립트는 다음을 생성합니다:
- `commission_tracking` 테이블
- 필요한 인덱스
- RLS (Row Level Security) 정책
- 자동 업데이트 트리거
- 프로젝트 시작 시 자동으로 수수료 생성하는 트리거

### 2. 코드 배포

변경된 파일들:
- `app/admin/page.tsx` - 관리자 대시보드 (시스템 설정 → 수수료 관리)
- `app/admin/commission/page.tsx` - 새로운 수수료 관리 페이지

## 📊 주요 기능

### 1. 자동 수수료 추적 ✅
- 고객이 프로젝트 시작 버튼을 누르면 (`in-progress` 상태로 변경)
- 자동으로 `commission_tracking` 테이블에 레코드가 생성됩니다
- 견적 금액의 10%가 수수료로 자동 계산됩니다

### 2. 수동 수수료 등록 ⭐ NEW
- "수동 등록" 버튼으로 관리자가 직접 추가 가능
- 고객이 버튼을 누르지 않았지만 프로젝트가 시작된 경우 사용
- 업체로부터 프로젝트 시작 확인을 받은 후 등록

### 3. 수수료 정보
다음 정보가 자동으로 저장됩니다:
- ✅ 업체명
- ✅ 프로젝트 제목
- ✅ 견적 금액
- ✅ 수수료 비율 (기본 10%)
- ✅ 수수료 금액
- ✅ 프로젝트 시작 날짜
- ✅ 수수료 상태 (미수령/수령완료)
- ✅ 등록 방법 (자동/수동)

### 4. 관리자 기능

#### 수수료 상태 관리
- **미수령 → 수령완료**: "수령완료" 버튼 클릭
- **수령완료 → 미수령**: "취소" 버튼 클릭

#### 메모 추가
- 각 수수료 항목에 메모를 추가할 수 있습니다
- 결제 관련 특이사항이나 참고사항 기록 가능

#### 필터링
- **전체**: 모든 수수료 내역
- **미수령**: 아직 받지 못한 수수료
- **수령완료**: 이미 받은 수수료

### 5. 대시보드 통계
관리자 대시보드에 새로운 통계 카드가 추가되었습니다:
- 미수령 수수료 총액 (CAD)
- 미수령 건수

## 🎯 사용 시나리오

### 시나리오 1: 정상 프로세스 (자동)
1. 고객이 견적서를 받음
2. 고객이 "프로젝트 시작" 버튼 클릭
3. ✅ 자동으로 수수료 추적 생성
4. 관리자가 수수료 관리 페이지에서 확인
5. 업체로부터 수수료 수령
6. 관리자가 "수령완료" 버튼 클릭

### 시나리오 2: 수동 등록 ⭐
```
1. 고객 "철수"가 수리 견적 요청
2. 4개 업체가 견적 제출
3. 고객이 "Pacas" 업체 선택
4. 고객이 "프로젝트 시작" 버튼을 누르지 않음 ⚠️
5. 업체로부터 "프로젝트 시작했습니다" 이메일 수신 📧
6. 관리자가 수수료 관리 페이지로 이동
7. "수동 등록" 버튼 클릭
8. 프로젝트 선택 → 업체 견적 선택 → 시작일 입력
9. "등록하기" 버튼 클릭
10. ✅ 수수료 추적 생성 (수동 등록 표시)
```

### 시나리오 3: 아직 시작 안함
```
1. 고객 "영희"가 화장실 리모델링 견적 요청
2. 2개 업체가 견적 제출
3. 고객이 아직 업체를 선택하지 않음 ❌
→ 수수료 관리 페이지에 표시 안됨
→ 수동 등록에도 나타나지 않음
```

## 📱 수동 등록 사용 방법

### 1단계: 수동 등록 버튼 클릭
수수료 관리 페이지 우측 상단의 "수동 등록" 버튼을 클릭합니다.

### 2단계: 프로젝트 선택
- 드롭다운에서 프로젝트를 선택합니다
- **등록 가능한 프로젝트 조건:**
  - 업체가 선택된 프로젝트 (selected_contractor_quote_id가 있음)
  - 아직 수수료 추적이 생성되지 않은 프로젝트

### 3단계: 업체 견적 선택
- 선택한 프로젝트의 견적서 목록이 표시됩니다
- 라디오 버튼으로 업체 선택
- 각 견적서에 수수료 금액이 표시됩니다

### 4단계: 시작일 입력
- 프로젝트 시작 날짜를 입력합니다
- 보통 업체로부터 확인받은 날짜를 입력합니다

### 5단계: 등록하기
- "등록하기" 버튼 클릭
- 성공 메시지 확인
- 수수료 목록에 "(수동 등록)" 표시와 함께 추가됨

## 📱 화면 구성

### 수수료 관리 페이지 (`/admin/commission`)

#### 상단 버튼
- **수동 등록**: 우측 상단의 파란색 버튼

#### 통계 카드
- 📊 미수령 수수료: 총액 및 건수
- ✅ 수령 완료: 총액 및 건수
- 💰 전체 수수료: 총액 및 건수

#### 필터 탭
- 전체 / 미수령 / 수령완료

#### 수수료 목록 테이블
| 업체명 | 프로젝트 | 견적금액 | 수수료 | 시작일 | 상태 | 메모 | 작업 |
|--------|----------|----------|--------|--------|------|------|------|
| ABC 건설<br>(수동 등록) | 주방 리모델링 | $15,000 | $1,500 | 2025-01-15 | 미수령 | (메모) | [수령완료] |

## 🔧 데이터베이스 스키마

### commission_tracking 테이블

```sql
CREATE TABLE commission_tracking (
  id UUID PRIMARY KEY,
  quote_request_id UUID REFERENCES quote_requests(id),
  contractor_id UUID REFERENCES contractors(id),
  contractor_name TEXT NOT NULL,
  project_title TEXT NOT NULL,
  quote_amount DECIMAL(12, 2) NOT NULL,
  commission_rate DECIMAL(5, 2) DEFAULT 10.00,
  commission_amount DECIMAL(12, 2) NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending', -- 'pending' or 'received'
  started_at TIMESTAMP WITH TIME ZONE,
  marked_manually BOOLEAN DEFAULT false, -- 수동 등록 여부
  payment_received_at TIMESTAMP WITH TIME ZONE,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### marked_manually 필드
- `true`: 관리자가 수동으로 등록
- `false`: 고객이 버튼을 눌러 자동 생성

## 🔐 보안

- RLS (Row Level Security) 활성화
- 관리자 이메일(`cmgg919@gmail.com`)만 접근 가능
- 모든 작업에 대한 권한 검증

## 📊 자동 vs 수동 비교

| 구분 | 자동 추적 | 수동 등록 |
|------|----------|----------|
| **생성 조건** | 고객이 "프로젝트 시작" 버튼 클릭 | 관리자가 "수동 등록" 버튼 클릭 |
| **marked_manually** | false | true |
| **표시** | 업체명만 표시 | 업체명 + "(수동 등록)" |
| **사용 시기** | 정상적인 프로세스 | 고객이 버튼을 누르지 않은 경우 |
| **시작일** | 버튼을 누른 시간 | 관리자가 입력한 날짜 |

## 🎓 베스트 프랙티스

### 수동 등록 시 주의사항

1. **확인 후 등록**
   - 반드시 업체로부터 프로젝트 시작 확인을 받은 후 등록
   - 이메일, 전화 등 증거 자료 확보

2. **정확한 날짜 입력**
   - 실제 프로젝트 시작일을 입력
   - 보통 업체가 알려준 날짜 사용

3. **메모 활용**
   - "업체 이메일로 확인 (2025-01-15)"
   - "전화로 프로젝트 시작 확인"
   - 등 참고사항 기록

4. **중복 확인**
   - 같은 프로젝트를 두 번 등록하지 않도록 주의
   - 시스템이 자동으로 중복을 방지하지만, 확인 필요

## 📈 향후 개선 사항

1. ~~**수동 등록 기능**~~ ✅ 완료
   - ~~고객이 버튼을 누르지 않은 경우 수동으로 등록~~

2. **수수료 비율 조정**
   - 업체별 또는 프로젝트별 수수료 비율 설정

3. **엑셀 내보내기**
   - 회계 처리를 위한 데이터 내보내기

4. **알림 기능**
   - 새로운 수수료 발생 시 이메일 알림
   - 장기 미수령 수수료 경고

5. **통계 및 리포트**
   - 월별/분기별 수수료 통계
   - 업체별 수수료 분석

## ❓ 문제 해결

### 수수료가 자동으로 생성되지 않는 경우

1. **프로젝트 상태 확인**
   ```sql
   SELECT id, title, status, selected_contractor_quote_id 
   FROM quote_requests 
   WHERE id = 'PROJECT_ID';
   ```

2. **트리거 확인**
   ```sql
   SELECT * FROM pg_trigger 
   WHERE tgname = 'trigger_create_commission_on_project_start';
   ```

3. **수동으로 등록**
   - 수수료 관리 페이지에서 "수동 등록" 버튼 사용

### 수동 등록 시 프로젝트가 안보이는 경우

**확인 사항:**
- 해당 프로젝트에 업체가 선택되었는지 확인
- 이미 수수료 추적이 생성되지 않았는지 확인

```sql
-- 프로젝트 확인
SELECT 
  qr.id,
  qr.title,
  qr.selected_contractor_quote_id,
  ct.id as commission_id
FROM quote_requests qr
LEFT JOIN commission_tracking ct ON qr.id = ct.quote_request_id
WHERE qr.id = 'PROJECT_ID';
```

### 중복 등록 방지

시스템이 자동으로 중복을 방지합니다:
- 이미 수수료 추적이 있는 프로젝트는 수동 등록 목록에서 제외됨
- 하지만 데이터베이스에서 직접 SQL로 추가하면 중복 가능하므로 주의

## 📞 지원

문제가 발생하거나 추가 기능이 필요한 경우 개발팀에 문의하세요.

---

**마지막 업데이트**: 2025-11-06  
**버전**: 2.0.0 (수동 등록 기능 추가)
